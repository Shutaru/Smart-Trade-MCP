# -*- coding: utf-8 -*-
"""
COMPLETE SYSTEM TEST - Smart Trade MCP

Tests ALL major components:
1. 42 Strategies (built-in + generated)
2. Genetic Algorithm Optimization
3. N-Fold Walk-Forward Analysis
4. Portfolio Optimization
5. Ray Parallel Processing

This is the ULTIMATE validation that everything works!
"""

import asyncio
import sys
from pathlib import Path
from datetime import datetime, timedelta
import json

sys.path.insert(0, str(Path(__file__).parent))

from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich import print as rprint

from src.core.data_manager import DataManager
from src.core.indicators import calculate_all_indicators
from src.strategies import registry
from src.optimization import (
    GeneticOptimizer,
    AllParameterSpaces,
    OptimizationConfig,
    WalkForwardAnalyzer,
    WalkForwardConfig,
)
from src.portfolio import PortfolioOptimizer, PortfolioConfig

console = Console()

# =========================================================================
# TEST CONFIGURATION
# =========================================================================

TEST_CONFIG = {
    "symbol": "BTC/USDT",
    "timeframe": "1h",
    "days_history": 200,  # ~8 months
    "max_candles": 5000,
    
    # Strategies to test
    "test_strategies": [
        "rsi",  # Built-in
        "macd",  # Built-in
        "volume_shooter",  # Built-in
        "rsi_band_reversion",  # Generated
        "trendflow_supertrend",  # Generated
        "multi_oscillator_confluence",  # Generated
    ],
    
    # Portfolio strategies
    "portfolio_strategies": [
        "rsi",
        "volume_shooter",
        "trendflow_supertrend",
    ],
    
    # Optimization config (quick for testing)
    "ga_population": 20,
    "ga_generations": 5,
    
    # WFA config
    "wfa_train_days": 120,
    "wfa_test_days": 40,
    "wfa_n_folds": 2,
}


# =========================================================================
# TEST 1: STRATEGY REGISTRY
# =========================================================================

async def test_strategy_registry():
    """Test that all strategies are registered and accessible"""
    
    console.rule("[bold cyan]TEST 1: Strategy Registry[/bold cyan]")
    print()
    
    # List all strategies
    all_strategies = registry.list_strategies()
    
    table = Table(title="📊 Registered Strategies", show_header=True)
    table.add_column("Name", style="cyan")
    table.add_column("Category", style="yellow")
    table.add_column("Description", style="white")
    
    # Group by category
    by_category = {}
    for strat in all_strategies:
        if strat.category not in by_category:
            by_category[strat.category] = []
        by_category[strat.category].append(strat)
    
    for category, strategies in sorted(by_category.items()):
        table.add_row(
            f"[bold]{category.upper()}[/bold]",
            "",
            f"{len(strategies)} strategies",
            style="bold green"
        )
        for strat in strategies[:3]:  # Show first 3
            table.add_row(
                f"  {strat.name}",
                strat.category,
                strat.description[:50] + "..."
            )
        if len(strategies) > 3:
            table.add_row(
                f"  ... and {len(strategies) - 3} more",
                "",
                "",
                style="dim"
            )
    
    console.print(table)
    print()
    
    # Test getting specific strategies
    console.print("[bold]Testing strategy instantiation...[/bold]")
    test_results = []
    
    for strategy_name in TEST_CONFIG["test_strategies"]:
        try:
            strategy = registry.get(strategy_name)
            indicators = strategy.get_required_indicators()
            test_results.append({
                "name": strategy_name,
                "status": "✅ OK",
                "indicators": len(indicators),
            })
        except Exception as e:
            test_results.append({
                "name": strategy_name,
                "status": f"❌ FAIL: {e}",
                "indicators": 0,
            })
    
    results_table = Table(show_header=True)
    results_table.add_column("Strategy")
    results_table.add_column("Status")
    results_table.add_column("Indicators")
    
    for result in test_results:
        results_table.add_row(
            result["name"],
            result["status"],
            str(result["indicators"])
        )
    
    console.print(results_table)
    print()
    
    return {
        "total_strategies": len(all_strategies),
        "categories": len(by_category),
        "test_passed": all("✅" in r["status"] for r in test_results),
    }


# =========================================================================
# TEST 2: PARAMETER SPACES
# =========================================================================

async def test_parameter_spaces():
    """Test that parameter spaces are defined for strategies"""
    
    console.rule("[bold cyan]TEST 2: Parameter Spaces[/bold cyan]")
    print()
    
    table = Table(title="📐 Parameter Spaces", show_header=True)
    table.add_column("Strategy")
    table.add_column("Param Space")
    table.add_column("# Params")
    table.add_column("Sample")
    
    results = []
    
    for strategy_name in TEST_CONFIG["test_strategies"]:
        try:
            # Try to get parameter space
            method_name = f"{strategy_name}_strategy"
            param_space_method = getattr(AllParameterSpaces, method_name, None)
            
            if param_space_method:
                param_space = param_space_method()
                sample = param_space.sample()
                
                table.add_row(
                    strategy_name,
                    "✅ Defined",
                    str(len(param_space)),
                    f"{list(sample.keys())[:2]}..."
                )
                results.append(True)
            else:
                table.add_row(
                    strategy_name,
                    "❌ Missing",
                    "0",
                    "-"
                )
                results.append(False)
        except Exception as e:
            table.add_row(
                strategy_name,
                f"❌ Error: {e}",
                "0",
                "-"
            )
            results.append(False)
    
    console.print(table)
    print()
    
    return {
        "total_tested": len(results),
        "with_param_space": sum(results),
        "test_passed": all(results),
    }


# =========================================================================
# TEST 3: GENETIC ALGORITHM OPTIMIZATION
# =========================================================================

async def test_genetic_optimization():
    """Test GA optimization on a strategy"""
    
    console.rule("[bold cyan]TEST 3: Genetic Algorithm Optimization[/bold cyan]")
    print()
    
    # Fetch data
    console.print("[bold]Fetching market data...[/bold]")
    dm = DataManager()
    
    end_date = datetime.now()
    start_date = end_date - timedelta(days=TEST_CONFIG["days_history"])
    
    df = await dm.fetch_historical(
        symbol=TEST_CONFIG["symbol"],
        timeframe=TEST_CONFIG["timeframe"],
        start_date=start_date,
        end_date=end_date,
        max_candles=TEST_CONFIG["max_candles"],
    )
    
    await dm.close()
    
    console.print(f"✅ Fetched {len(df)} candles")
    print()
    
    # Test on RSI strategy
    strategy_name = "rsi"
    console.print(f"[bold]Optimizing {strategy_name} strategy...[/bold]")
    
    strategy = registry.get(strategy_name)
    
    # Calculate indicators
    required = strategy.get_required_indicators()
    df = calculate_all_indicators(df, required, use_gpu=False)
    
    # Get parameter space
    param_space = AllParameterSpaces.rsi_strategy()
    
    # Create config
    config = OptimizationConfig(
        population_size=TEST_CONFIG["ga_population"],
        n_generations=TEST_CONFIG["ga_generations"],
        use_gpu=False,
    )
    
    # Run optimization
    optimizer = GeneticOptimizer(
        df=df,
        strategy_class=strategy,
        param_space=param_space,
        config=config,
    )
    
    results = optimizer.optimize()
    
    # Display results
    results_table = Table(title="🧬 GA Optimization Results")
    results_table.add_column("Metric")
    results_table.add_column("Value")
    
    results_table.add_row("Best Sharpe", f"{results['best_fitness']['sharpe_ratio']:.2f}")
    results_table.add_row("Best Win Rate", f"{results['best_fitness']['win_rate']:.1f}%")
    results_table.add_row("Max Drawdown", f"{results['best_fitness']['max_drawdown_pct']:.1f}%")
    results_table.add_row("Total Time", f"{results['total_time']:.1f}s")
    results_table.add_row("Evaluations", str(results['total_evaluations']))
    
    console.print(results_table)
    print()
    
    # Show best params
    params_table = Table(title="📊 Best Parameters")
    params_table.add_column("Parameter")
    params_table.add_column("Value")
    
    for param, value in results['best_params'].items():
        params_table.add_row(param, str(value))
    
    console.print(params_table)
    print()
    
    return {
        "strategy": strategy_name,
        "best_sharpe": results['best_fitness']['sharpe_ratio'],
        "total_time": results['total_time'],
        "test_passed": results['best_fitness']['sharpe_ratio'] > -10,  # Sanity check
    }


# =========================================================================
# TEST 4: N-FOLD WALK-FORWARD ANALYSIS
# =========================================================================

async def test_nfold_walk_forward():
    """Test N-Fold WFA"""
    
    console.rule("[bold cyan]TEST 4: N-Fold Walk-Forward Analysis[/bold cyan]")
    print()
    
    # Fetch data
    console.print("[bold]Fetching market data...[/bold]")
    dm = DataManager()
    
    end_date = datetime.now()
    start_date = end_date - timedelta(days=TEST_CONFIG["days_history"])
    
    df = await dm.fetch_historical(
        symbol=TEST_CONFIG["symbol"],
        timeframe=TEST_CONFIG["timeframe"],
        start_date=start_date,
        end_date=end_date,
        max_candles=TEST_CONFIG["max_candles"],
    )
    
    await dm.close()
    
    console.print(f"✅ Fetched {len(df)} candles")
    print()
    
    # Test on MACD strategy
    strategy_name = "macd"
    console.print(f"[bold]Running N-Fold WFA on {strategy_name}...[/bold]")
    
    strategy = registry.get(strategy_name)
    
    # Calculate indicators
    required = strategy.get_required_indicators()
    df = calculate_all_indicators(df, required, use_gpu=False)
    
    # Get parameter space
    param_space = AllParameterSpaces.macd_strategy()
    
    # Create WFA config
    config = WalkForwardConfig(
        train_days=TEST_CONFIG["wfa_train_days"],
        test_days=TEST_CONFIG["wfa_test_days"],
        step_days=30,
        n_folds=TEST_CONFIG["wfa_n_folds"],
        use_parallel=False,  # Sequential for testing
        population_size=10,  # Small for speed
        n_generations=3,
    )
    
    # Run WFA
    analyzer = WalkForwardAnalyzer(
        df=df,
        strategy_class=strategy,
        param_space=param_space,
        config=config,
    )
    
    results = analyzer.analyze()
    
    # Display results
    results_table = Table(title="📊 N-Fold WFA Results")
    results_table.add_column("Metric")
    results_table.add_column("Value")
    
    results_table.add_row("Total Windows", str(results.total_windows))
    results_table.add_row("Valid Windows", str(results.valid_windows))
    results_table.add_row("Consistency", f"{results.consistency_score:.1f}%")
    results_table.add_row("Avg Test Sharpe", f"{results.avg_test_sharpe:.2f}")
    results_table.add_row("Sharpe Degradation", f"{results.avg_sharpe_degradation:+.1f}%")
    results_table.add_row("Robustness Score", f"{results.robustness_score:.1f}/100")
    results_table.add_row("Is Robust?", "✅ YES" if results.is_robust else "❌ NO")
    results_table.add_row("Total Time", f"{results.total_time:.1f}s")
    
    console.print(results_table)
    print()
    
    return {
        "strategy": strategy_name,
        "total_windows": results.total_windows,
        "valid_windows": results.valid_windows,
        "is_robust": results.is_robust,
        "robustness_score": results.robustness_score,
        "test_passed": results.total_windows > 0,
    }


# =========================================================================
# TEST 5: PORTFOLIO OPTIMIZATION
# =========================================================================

async def test_portfolio_optimization():
    """Test portfolio optimization"""
    
    console.rule("[bold cyan]TEST 5: Portfolio Optimization[/bold cyan]")
    print()
    
    # Fetch data
    console.print("[bold]Fetching market data...[/bold]")
    dm = DataManager()
    
    end_date = datetime.now()
    start_date = end_date - timedelta(days=TEST_CONFIG["days_history"])
    
    df = await dm.fetch_historical(
        symbol=TEST_CONFIG["symbol"],
        timeframe=TEST_CONFIG["timeframe"],
        start_date=start_date,
        end_date=end_date,
        max_candles=TEST_CONFIG["max_candles"],
    )
    
    await dm.close()
    
    console.print(f"✅ Fetched {len(df)} candles")
    print()
    
    # Calculate all indicators
    console.print("[bold]Calculating indicators for all strategies...[/bold]")
    all_indicators = set()
    for strategy_name in TEST_CONFIG["portfolio_strategies"]:
        strategy = registry.get(strategy_name)
        all_indicators.update(strategy.get_required_indicators())
    
    df = calculate_all_indicators(df, list(all_indicators), use_gpu=False)
    console.print(f"✅ Calculated {len(all_indicators)} indicators")
    print()
    
    # Create portfolio config
    console.print(f"[bold]Optimizing portfolio with {len(TEST_CONFIG['portfolio_strategies'])} strategies...[/bold]")
    
    config = PortfolioConfig(
        strategies=TEST_CONFIG["portfolio_strategies"],
        optimization_method="max_sharpe",
        min_weight=0.2,
        max_weight=0.5,
    )
    
    # Run optimization
    optimizer = PortfolioOptimizer(df=df, config=config)
    weights = optimizer.optimize()
    metrics = optimizer.get_portfolio_metrics()
    
    # Display results
    weights_table = Table(title="💼 Portfolio Weights")
    weights_table.add_column("Strategy")
    weights_table.add_column("Weight")
    weights_table.add_column("Individual Sharpe")
    
    for strategy_name, weight in weights.items():
        individual_perf = metrics["strategy_performances"][strategy_name]
        weights_table.add_row(
            strategy_name,
            f"{weight*100:.1f}%",
            f"{individual_perf['sharpe']:.2f}"
        )
    
    console.print(weights_table)
    print()
    
    # Portfolio metrics
    metrics_table = Table(title="📊 Portfolio Metrics")
    metrics_table.add_column("Metric")
    metrics_table.add_column("Value")
    
    metrics_table.add_row("Portfolio Sharpe", f"{metrics['portfolio_sharpe']:.2f}")
    metrics_table.add_row("Portfolio Volatility", f"{metrics['portfolio_volatility']:.2%}")
    metrics_table.add_row("Max Drawdown", f"{metrics['portfolio_max_drawdown']:.1f}%")
    metrics_table.add_row("Total Return", f"{metrics['portfolio_total_return']:.1f}%")
    
    console.print(metrics_table)
    print()
    
    return {
        "n_strategies": len(TEST_CONFIG["portfolio_strategies"]),
        "portfolio_sharpe": metrics["portfolio_sharpe"],
        "portfolio_return": metrics["portfolio_total_return"],
        "test_passed": metrics["portfolio_sharpe"] > -10,  # Sanity check
    }


# =========================================================================
# MAIN TEST RUNNER
# =========================================================================

async def main():
    """Run all tests"""
    
    console.clear()
    
    # Header
    panel = Panel(
        "[bold cyan]SMART TRADE MCP - COMPLETE SYSTEM TEST[/bold cyan]\n\n"
        "Testing ALL major components:\n"
        "  1. Strategy Registry (42+ strategies)\n"
        "  2. Parameter Spaces\n"
        "  3. Genetic Algorithm Optimization\n"
        "  4. N-Fold Walk-Forward Analysis\n"
        "  5. Portfolio Optimization\n\n"
        f"Symbol: {TEST_CONFIG['symbol']} | Timeframe: {TEST_CONFIG['timeframe']}",
        style="bold blue"
    )
    console.print(panel)
    print()
    
    # Run tests
    results = {}
    
    try:
        # TEST 1
        results["test1"] = await test_strategy_registry()
        
        # TEST 2
        results["test2"] = await test_parameter_spaces()
        
        # TEST 3
        results["test3"] = await test_genetic_optimization()
        
        # TEST 4
        results["test4"] = await test_nfold_walk_forward()
        
        # TEST 5
        results["test5"] = await test_portfolio_optimization()
        
    except Exception as e:
        console.print(f"[bold red]❌ Test failed with error: {e}[/bold red]")
        import traceback
        traceback.print_exc()
        return
    
    # Final summary
    console.rule("[bold green]FINAL SUMMARY[/bold green]")
    print()
    
    summary_table = Table(title="✅ Test Results Summary", show_header=True)
    summary_table.add_column("Test")
    summary_table.add_column("Status")
    summary_table.add_column("Details")
    
    summary_table.add_row(
        "1. Strategy Registry",
        "✅ PASS" if results["test1"]["test_passed"] else "❌ FAIL",
        f"{results['test1']['total_strategies']} strategies, {results['test1']['categories']} categories"
    )
    
    summary_table.add_row(
        "2. Parameter Spaces",
        "✅ PASS" if results["test2"]["test_passed"] else "❌ FAIL",
        f"{results['test2']['with_param_space']}/{results['test2']['total_tested']} defined"
    )
    
    summary_table.add_row(
        "3. GA Optimization",
        "✅ PASS" if results["test3"]["test_passed"] else "❌ FAIL",
        f"Sharpe: {results['test3']['best_sharpe']:.2f}, Time: {results['test3']['total_time']:.1f}s"
    )
    
    summary_table.add_row(
        "4. N-Fold WFA",
        "✅ PASS" if results["test4"]["test_passed"] else "❌ FAIL",
        f"{results['test4']['valid_windows']}/{results['test4']['total_windows']} valid, "
        f"Robust: {'YES' if results['test4']['is_robust'] else 'NO'}"
    )
    
    summary_table.add_row(
        "5. Portfolio Optimization",
        "✅ PASS" if results["test5"]["test_passed"] else "❌ FAIL",
        f"Sharpe: {results['test5']['portfolio_sharpe']:.2f}, "
        f"Return: {results['test5']['portfolio_return']:.1f}%"
    )
    
    console.print(summary_table)
    print()
    
    # Overall result
    all_passed = all(
        results[f"test{i}"]["test_passed"] 
        for i in range(1, 6)
    )
    
    if all_passed:
        console.print(
            Panel(
                "[bold green]🎉 ALL TESTS PASSED! 🎉[/bold green]\n\n"
                "Smart Trade MCP is fully operational!\n"
                "  ✅ 42+ Strategies ready\n"
                "  ✅ Parameter spaces defined\n"
                "  ✅ GA Optimization working\n"
                "  ✅ N-Fold WFA working\n"
                "  ✅ Portfolio optimization working\n\n"
                "Ready for production use! 🚀",
                style="bold green"
            )
        )
    else:
        console.print(
            Panel(
                "[bold red]❌ SOME TESTS FAILED[/bold red]\n\n"
                "Please review the results above.",
                style="bold red"
            )
        )
    
    print()
    
    # Save results
    with open("test_results.json", "w") as f:
        json.dump(results, f, indent=2, default=str)
    
    console.print("💾 Results saved to: test_results.json")
    print()


if __name__ == "__main__":
    asyncio.run(main())
