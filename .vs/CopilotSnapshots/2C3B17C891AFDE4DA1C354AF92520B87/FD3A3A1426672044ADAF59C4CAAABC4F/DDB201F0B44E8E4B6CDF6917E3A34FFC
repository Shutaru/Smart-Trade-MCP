"""Regime Adaptive Core"""
from typing import List
import pandas as pd
from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class RegimeAdaptiveCore(BaseStrategy):
    """
    RegimeAdaptiveCore - Adapts strategy based on market regime detection
    
    Category: hybrid
    Indicators: adx, atr, ema, rsi
    """

    def __init__(self, config: StrategyConfig = None):
        """Initialize RegimeAdaptiveCore strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.adx_period = self.config.get("adx_period", 14)
        self.adx_threshold_trending = self.config.get("adx_threshold_trending", 25)
        self.adx_threshold_ranging = self.config.get("adx_threshold_ranging", 20)
        self.atr_period = self.config.get("atr_period", 14)
        self.regime_lookback = self.config.get("regime_lookback", 100)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        """Required indicators for this strategy."""
        return ["adx", "ema", "rsi", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        """
        Generate trading signals.
        
        Args:
            df: DataFrame with OHLCV and indicator data
            
        Returns:
            List of trading signals
        """
        signals, pos = [], None
        
        for i in range(max(self.adx_period, self.regime_lookback), len(df)):
            r = df.iloc[i]
            close = r["close"]
            adx = r.get("adx", 0)
            ema_200 = r.get("ema_200", close)
            rsi = r.get("rsi", 50)
            atr = r.get("atr", close*0.02)
            
            # ✅ USE adx_threshold parameters for regime detection
            trending = adx > self.adx_threshold_trending
            ranging = adx <= self.adx_threshold_ranging
            
            if pos is None:
                # TRENDING regime - follow trend (trend following strategy)
                if trending:
                    # LONG: Uptrend + momentum
                    if close > ema_200 and rsi > 50:
                        sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                        signals.append(Signal(
                            SignalType.LONG, 
                            r["timestamp"], 
                            close, 
                            min(1.0, adx / 40),  # Confidence based on trend strength
                            sl, 
                            tp, 
                            {
                                "regime": "trending",
                                "adx": adx,
                                "adx_threshold_trending": self.adx_threshold_trending
                            }
                        ))
                        pos = "LONG"
                    
                    # SHORT: Downtrend + momentum
                    elif close < ema_200 and rsi < 50:
                        sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                        signals.append(Signal(
                            SignalType.SHORT, 
                            r["timestamp"], 
                            close, 
                            min(1.0, adx / 40),
                            sl, 
                            tp,
                            {
                                "regime": "trending",
                                "adx": adx,
                                "adx_threshold_trending": self.adx_threshold_trending
                            }
                        ))
                        pos = "SHORT"
                
                # RANGING regime - mean reversion strategy
                elif ranging:
                    # LONG: RSI oversold (mean reversion)
                    if rsi < 30:
                        sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                        signals.append(Signal(
                            SignalType.LONG, 
                            r["timestamp"], 
                            close, 
                            0.7, 
                            sl, 
                            tp,
                            {
                                "regime": "ranging",
                                "adx": adx,
                                "adx_threshold_ranging": self.adx_threshold_ranging,
                                "rsi": rsi
                            }
                        ))
                        pos = "LONG"
                    
                    # SHORT: RSI overbought (mean reversion)
                    elif rsi > 70:
                        sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                        signals.append(Signal(
                            SignalType.SHORT, 
                            r["timestamp"], 
                            close, 
                            0.7, 
                            sl, 
                            tp,
                            {
                                "regime": "ranging",
                                "adx": adx,
                                "adx_threshold_ranging": self.adx_threshold_ranging,
                                "rsi": rsi
                            }
                        ))
                        pos = "SHORT"
            
            # Exit when regime changes or conditions invalidate
            elif pos == "LONG":
                # Exit if trend reversed (in trending) or RSI extreme (in ranging)
                regime_changed = (trending and close < ema_200) or (ranging and rsi > 70)
                
                if regime_changed:
                    signals.append(Signal(
                        SignalType.CLOSE_LONG, 
                        r["timestamp"], 
                        close,
                        metadata={
                            "reason": "Regime conditions changed",
                            "current_regime": "trending" if trending else "ranging"
                        }
                    ))
                    pos = None
            
            elif pos == "SHORT":
                # Exit if trend reversed (in trending) or RSI extreme (in ranging)
                regime_changed = (trending and close > ema_200) or (ranging and rsi < 30)
                
                if regime_changed:
                    signals.append(Signal(
                        SignalType.CLOSE_SHORT, 
                        r["timestamp"], 
                        close,
                        metadata={
                            "reason": "Regime conditions changed",
                            "current_regime": "trending" if trending else "ranging"
                        }
                    ))
                    pos = None
                    
        logger.info(f"RegimeAdaptiveCore: {len(signals)} signals")
        return signals


__all__ = ["RegimeAdaptiveCore"]
