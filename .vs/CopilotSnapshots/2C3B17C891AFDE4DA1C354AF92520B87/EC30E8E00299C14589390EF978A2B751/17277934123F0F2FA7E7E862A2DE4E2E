"""
MFI Impulse Momentum
"""

from typing import List
import pandas as pd

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class MfiImpulseMomentum(BaseStrategy):
    """
    MfiImpulseMomentum - MFI surge indicates strong buying/selling pressure
    
    Category: momentum
    Indicators: mfi, ema, atr
    """

    def __init__(self, config: StrategyConfig = None):
        """Initialize MfiImpulseMomentum strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.mfi_period = self.config.get("mfi_period", 14)
        self.mfi_threshold_high = self.config.get("mfi_threshold_high", 80)
        self.mfi_threshold_low = self.config.get("mfi_threshold_low", 20)
        self.ema_period = self.config.get("ema_period", 20)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        """Required indicators for this strategy."""
        return ["mfi", "ema", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        """
        Generate trading signals.
        
        Args:
            df: DataFrame with OHLCV and indicator data
            
        Returns:
            List of trading signals
        """
        signals, pos = [], None
        
        for i in range(max(5, self.mfi_period), len(df)):
            r = df.iloc[i]
            close = r["close"]
            mfi = r.get("mfi", 50)
            # ✅ USE ema_period parameter
            ema_val = r.get(f"ema_{self.ema_period}", close)
            atr = r.get("atr", close*0.02)
            
            # MFI impulse detection (5-bar surge)
            mfi_5ago = df.iloc[i-5].get("mfi", 50)
            mfi_surge = mfi - mfi_5ago
            
            # Trend confirmation
            bullish_trend = close > ema_val
            bearish_trend = close < ema_val
            
            if pos is None:
                # ✅ USE mfi_threshold_low and mfi_threshold_high parameters
                # LONG: MFI surge from oversold + bullish trend
                mfi_oversold_bounce = (
                    mfi_surge > 10 and  # Strong surge
                    mfi < self.mfi_threshold_high and  # Not overbought yet
                    bullish_trend  # Price above EMA
                )
                
                if mfi_oversold_bounce:
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        SignalType.LONG, 
                        r["timestamp"], 
                        close, 
                        min(1.0, abs(mfi_surge) / 20),  # Confidence based on surge strength
                        sl, 
                        tp, 
                        {
                            "mfi": mfi,
                            "mfi_surge": mfi_surge,
                            "mfi_threshold_high": self.mfi_threshold_high,
                            "ema_period": self.ema_period
                        }
                    ))
                    pos = "LONG"
                
                # SHORT: MFI drop from overbought + bearish trend
                mfi_overbought_drop = (
                    mfi_surge < -10 and  # Strong drop
                    mfi > self.mfi_threshold_low and  # Not oversold yet
                    bearish_trend  # Price below EMA
                )
                
                if mfi_overbought_drop:
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        SignalType.SHORT, 
                        r["timestamp"], 
                        close, 
                        min(1.0, abs(mfi_surge) / 20),
                        sl, 
                        tp, 
                        {
                            "mfi": mfi,
                            "mfi_surge": mfi_surge,
                            "mfi_threshold_low": self.mfi_threshold_low,
                            "ema_period": self.ema_period
                        }
                    ))
                    pos = "SHORT"
            
            # Exit when MFI momentum reverses or hits opposite extreme
            elif pos == "LONG":
                current_surge = mfi - df.iloc[i-5].get("mfi", 50)
                # ✅ Exit if surge reverses or MFI overbought
                if current_surge < -5 or mfi > self.mfi_threshold_high:
                    signals.append(Signal(
                        SignalType.CLOSE_LONG, 
                        r["timestamp"], 
                        close,
                        metadata={"reason": "MFI momentum reversed or overbought", "mfi": mfi}
                    ))
                    pos = None
            
            elif pos == "SHORT":
                current_surge = mfi - df.iloc[i-5].get("mfi", 50)
                # ✅ Exit if surge reverses or MFI oversold
                if current_surge > 5 or mfi < self.mfi_threshold_low:
                    signals.append(Signal(
                        SignalType.CLOSE_SHORT, 
                        r["timestamp"], 
                        close,
                        metadata={"reason": "MFI momentum reversed or oversold", "mfi": mfi}
                    ))
                    pos = None
                    
        logger.info(f"MfiImpulseMomentum: {len(signals)} signals")
        return signals


__all__ = ["MfiImpulseMomentum"]
