import { useState, useMemo, useEffect } from 'react'
import MoneyFlowChart from './MoneyFlowChart'

interface AgentSummary {
  agent_id: string
  symbol: string
  timeframe: string
  strategy: string
  status: string
  total_trades?: number
  total_pnl?: number
}

export default function BotsList({ agents, onSelect }: { agents: AgentSummary[]; onSelect: (id: string) => void }) {
  const [query, setQuery] = useState('')
  const [seriesMap, setSeriesMap] = useState<Record<string, { time: string; value: number }[]>>({})
  const filtered = useMemo(() => {
    if (!query) return agents
    const q = query.toLowerCase()
    return agents.filter(a => `${a.strategy} ${a.symbol} ${a.timeframe}`.toLowerCase().includes(q))
  }, [agents, query])

  const loading = agents === null || agents === undefined

  useEffect(() => {
    let mounted = true
    const controllers: Record<string, AbortController> = {}

    async function fetchSeries(agentId: string) {
      if (seriesMap[agentId]) return
      const ctrl = new AbortController()
      controllers[agentId] = ctrl
      try {
        const res = await fetch(`/api/v1/paper/bots/${encodeURIComponent(agentId)}`, { signal: ctrl.signal })
        if (!res.ok) return
        const data = await res.json()
        const series = data?.performance?.equity_series || []
        if (!mounted) return
        setSeriesMap(prev => ({ ...prev, [agentId]: series }))
      } catch (e) {
        // ignore aborts and errors
      } finally {
        delete controllers[agentId]
      }
    }

    // fetch for first N visible agents to avoid too many requests
    const toFetch = filtered.slice(0, 8).map(a => a.agent_id).filter(id => !!id && !seriesMap[id])
    toFetch.forEach(id => fetchSeries(id))

    return () => {
      mounted = false
      Object.values(controllers).forEach(c => c.abort())
    }
  }, [filtered, seriesMap])

  return (
    <div>
      <div className="card-panel">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-lg font-semibold">Active Bots</h3>
          <input
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="Search bots..."
            className="px-3 py-1 rounded-md border" />
        </div>

        {loading ? (
          <div className="space-y-3">
            <div className="h-16 bg-gray-100 rounded animate-pulse" />
            <div className="h-16 bg-gray-100 rounded animate-pulse" />
            <div className="h-16 bg-gray-100 rounded animate-pulse" />
          </div>
        ) : filtered.length === 0 ? (
          <div className="text-sm small-muted">No active bots</div>
        ) : (
          <div className="space-y-3">
            {filtered.map((a) => (
              <div
                key={a.agent_id}
                className="w-full p-3 border rounded-lg hover:shadow-md transition cursor-pointer flex items-center gap-4"
                role="button"
                tabIndex={0}
                onClick={() => onSelect(a.agent_id)}
                onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') onSelect(a.agent_id) }}
              >
                <div style={{ width: 220, height: 60 }} className="rounded overflow-hidden bg-panel/30 p-1">
                  {seriesMap[a.agent_id] && seriesMap[a.agent_id].length > 0 ? (
                    <MoneyFlowChart series={seriesMap[a.agent_id]} />
                  ) : (
                    <div className="h-full flex items-center justify-center text-xs small-muted">Loading chart...</div>
                  )}
                </div>

                <div className="flex-1">
                  <div className="font-semibold">{a.symbol} <span className="text-sm small-muted">| {a.strategy} ({a.timeframe})</span></div>
                  <div className="text-sm small-muted">ID: {a.agent_id}</div>
                </div>

                <div className="text-right w-28 small-muted">
                  <div className={`px-2 py-1 rounded ${a.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>{a.status}</div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
