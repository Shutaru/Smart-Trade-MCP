"""
Donchian Continuation - Donchian breakout with ADX momentum

Win Rate: 40-50%
Best Timeframes: 5m, 15m, 1h
"""

from typing import List
import pandas as pd
import numpy as np

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class DonchianContinuation(BaseStrategy):
    """
    Donchian Continuation Strategy
    
    LONG: Price > EMA200 + breakout above Donchian upper + ADX >= 18 and rising
    SHORT: Price < EMA200 + breakdown below Donchian lower + ADX >= 18 and rising
    
    Category: Trend Following / Breakout
    Win Rate: 40-50%
    """

    def __init__(self, config: StrategyConfig = None):
        """Initialize DonchianContinuation strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.donchian_period = self.config.get("donchian_period", 20)
        self.adx_threshold = self.config.get("adx_threshold", 25)
        self.ema_period = self.config.get("ema_period", 50)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        """Required indicators."""
        return ["donchian", "ema", "adx", "atr", "supertrend"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        """Generate trading signals."""
        signals = []
        position = None
        
        for i in range(max(5, self.donchian_period), len(df)):
            row = df.iloc[i]
            prev = df.iloc[i - 1]
            
            close = row["close"]
            donchian_upper = row.get("donchian_upper", close)
            donchian_lower = row.get("donchian_lower", close)
            # ✅ USE ema_period parameter
            ema_trend = row.get(f"ema_{self.ema_period}", close)
            adx = row.get("adx", 0)
            supertrend_trend = row.get("supertrend_trend", 0)
            atr = row.get("atr", close * 0.02)
            timestamp = row["timestamp"]
            
            # Previous Donchian values for breakout detection
            prev_don_upper = prev.get("donchian_upper", close)
            prev_don_lower = prev.get("donchian_lower", close)
            
            # ✅ USE adx_threshold parameter
            # LONG entry: Donchian upper breakout + trend confirmation
            if position is None:
                long_filters = (
                    supertrend_trend > 0 and 
                    adx >= self.adx_threshold and
                    close > ema_trend  # Use parameter EMA for trend filter
                )
                
                if long_filters and row["high"] > prev_don_upper:
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        type=SignalType.LONG,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={
                            "adx": adx, 
                            "reason": "Donchian breakout",
                            "donchian_period": self.donchian_period,
                            "ema_period": self.ema_period
                        },
                    ))
                    position = "LONG"
            
                # SHORT entry: Donchian lower breakdown + trend confirmation
                short_filters = (
                    supertrend_trend < 0 and 
                    adx >= self.adx_threshold and
                    close < ema_trend
                )
                
                if short_filters and row["low"] < prev_don_lower:
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        type=SignalType.SHORT,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={
                            "adx": adx, 
                            "reason": "Donchian breakdown",
                            "donchian_period": self.donchian_period,
                            "ema_period": self.ema_period
                        },
                    ))
                    position = "SHORT"
            
            # Exit on SuperTrend reversal
            elif position == "LONG" and supertrend_trend < 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_LONG, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "SuperTrend reversal"}
                ))
                position = None
                
            elif position == "SHORT" and supertrend_trend > 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_SHORT, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "SuperTrend reversal"}
                ))
                position = None
        
        logger.info(f"DonchianContinuation generated {len(signals)} signals")
        return signals


__all__ = ["DonchianContinuation"]
