"""
ADX Trend Filter Plus - Pure ADX trend strength with EMA alignment

Win Rate: 48-58%
Best Timeframes: 15m, 1h, 4h
"""

from typing import List
import pandas as pd

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class AdxTrendFilterPlus(BaseStrategy):
    """ADX Trend Filter - Strong ADX + EMA alignment + RSI pullback"""

    def __init__(self, config: StrategyConfig = None):
        """Initialize AdxTrendFilterPlus strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.adx_period = self.config.get("adx_period", 14)
        self.adx_threshold = self.config.get("adx_threshold", 25)
        self.ema_fast = self.config.get("ema_fast", 20)
        self.ema_slow = self.config.get("ema_slow", 50)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        return ["adx", "ema", "rsi", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        signals = []
        position = None
        
        for i in range(1, len(df)):
            row = df.iloc[i]
            prev = df.iloc[i - 1]
            
            close = row["close"]
            adx = row.get("adx", 0)
            rsi = row.get("rsi", 50)
            # ✅ USE ema_fast and ema_slow parameters
            ema_fast_val = row.get(f"ema_{self.ema_fast}", close)
            ema_slow_val = row.get(f"ema_{self.ema_slow}", close)
            atr = row.get("atr", close * 0.02)
            timestamp = row["timestamp"]
            
            # EMA alignment check
            ema_aligned_bull = ema_fast_val > ema_slow_val
            ema_aligned_bear = ema_fast_val < ema_slow_val
            
            # RSI range (35-65 for flexibility)
            rsi_lower = 35
            rsi_upper = 65
            
            # ✅ USE adx_threshold parameter
            # LONG: ADX strong + bullish EMA alignment + price above slow EMA
            if position is None and close > ema_slow_val:
                if adx >= self.adx_threshold and ema_aligned_bull and rsi_lower <= rsi <= rsi_upper:
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        type=SignalType.LONG,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={
                            "adx": adx, 
                            "rsi": rsi,
                            "ema_fast": self.ema_fast,
                            "ema_slow": self.ema_slow
                        },
                    ))
                    position = "LONG"
            
            # SHORT: ADX strong + bearish EMA alignment + price below slow EMA
            elif position is None and close < ema_slow_val:
                if adx >= self.adx_threshold and ema_aligned_bear and rsi_lower <= rsi <= rsi_upper:
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        type=SignalType.SHORT,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={
                            "adx": adx, 
                            "rsi": rsi,
                            "ema_fast": self.ema_fast,
                            "ema_slow": self.ema_slow
                        },
                    ))
                    position = "SHORT"
            
            # Exit on EMA cross (trend reversal)
            elif position == "LONG" and not ema_aligned_bull:
                signals.append(Signal(
                    type=SignalType.CLOSE_LONG, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "EMA alignment lost"}
                ))
                position = None
                
            elif position == "SHORT" and not ema_aligned_bear:
                signals.append(Signal(
                    type=SignalType.CLOSE_SHORT, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "EMA alignment lost"}
                ))
                position = None
        
        logger.info(f"AdxTrendFilterPlus generated {len(signals)} signals")
        return signals


__all__ = ["AdxTrendFilterPlus"]
