"""
MACD Zero Trend - MACD histogram crosses zero with trend confirmation

Win Rate: 45-52%
Best Timeframes: 15m, 1h
"""

from typing import List
import pandas as pd

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class MacdZeroTrend(BaseStrategy):
    """MACD Zero Line Trend - MACD hist > 0 + breakout"""

    def __init__(self, config: StrategyConfig = None):
        """Initialize MacdZeroTrend strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.fast_period = self.config.get("fast_period", 12)
        self.slow_period = self.config.get("slow_period", 26)
        self.signal_period = self.config.get("signal_period", 9)
        self.ema_trend = self.config.get("ema_trend", 200)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        return ["macd", "ema", "rsi", "adx", "supertrend", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        signals = []
        position = None
        
        for i in range(1, len(df)):
            row = df.iloc[i]
            prev = df.iloc[i - 1]
            
            close = row["close"]
            macd_hist = row.get("macd_hist", 0)
            rsi = row.get("rsi", 50)
            # ✅ USE ema_trend parameter
            ema_trend_val = row.get(f"ema_{self.ema_trend}", close)
            adx = row.get("adx", 0)
            supertrend_trend = row.get("supertrend_trend", 0)
            atr = row.get("atr", close * 0.02)
            timestamp = row["timestamp"]
            
            # RSI range (can add as parameters if needed)
            rsi_lower = 30
            rsi_upper = 75
            min_adx = 15  # Could use a parameter
            
            # LONG: MACD > 0 + SuperTrend bullish + price above trend EMA
            if position is None:
                if (macd_hist > 0 and 
                    supertrend_trend > 0 and 
                    close > ema_trend_val and
                    adx >= min_adx and 
                    rsi_lower < rsi < rsi_upper):
                    
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        type=SignalType.LONG, 
                        timestamp=timestamp, 
                        price=close,
                        confidence=min(1.0, adx / 40), 
                        stop_loss=sl, 
                        take_profit=tp,
                        metadata={"macd_hist": macd_hist, "adx": adx, "ema_trend": self.ema_trend}
                    ))
                    position = "LONG"
            
                # SHORT: MACD < 0 + SuperTrend bearish + price below trend EMA
                elif (macd_hist < 0 and 
                      supertrend_trend < 0 and 
                      close < ema_trend_val and
                      adx >= min_adx and 
                      rsi_lower < rsi < rsi_upper):
                    
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        type=SignalType.SHORT, 
                        timestamp=timestamp, 
                        price=close,
                        confidence=min(1.0, adx / 40), 
                        stop_loss=sl, 
                        take_profit=tp,
                        metadata={"macd_hist": macd_hist, "adx": adx, "ema_trend": self.ema_trend}
                    ))
                    position = "SHORT"
            
            # Exit on SuperTrend reversal
            elif position == "LONG" and supertrend_trend < 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_LONG, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "SuperTrend reversal"}
                ))
                position = None
                
            elif position == "SHORT" and supertrend_trend > 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_SHORT, 
                    timestamp=timestamp, 
                    price=close, 
                    metadata={"reason": "SuperTrend reversal"}
                ))
                position = None
        
        logger.info(f"MacdZeroTrend generated {len(signals)} signals")
        return signals


__all__ = ["MacdZeroTrend"]
