"""
ADX Trend Filter Plus - Pure ADX trend strength with EMA alignment

Win Rate: 48-58%
Best Timeframes: 15m, 1h, 4h
"""

from typing import List
import pandas as pd

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class AdxTrendFilterPlus(BaseStrategy):
    """ADX Trend Filter - Strong ADX + EMA alignment + RSI pullback"""

    def __init__(self, config: StrategyConfig = None):
        """Initialize AdxTrendFilterPlus strategy."""
        super().__init__(config)
        
        # OPTIMIZABLE PARAMETERS
        self.adx_period = self.config.get("adx_period", 14)
        self.adx_threshold = self.config.get("adx_threshold", 25)
        self.ema_fast = self.config.get("ema_fast", 20)
        self.ema_slow = self.config.get("ema_slow", 50)
        self.sl_atr_mult = self.config.get("sl_atr_mult", 2.0)
        self.tp_rr_mult = self.config.get("tp_rr_mult", 2.5)

    def get_required_indicators(self) -> List[str]:
        return ["adx", "ema", "rsi", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        signals = []
        position = None
        
        for i in range(1, len(df)):
            row = df.iloc[i]
            prev = df.iloc[i - 1]
            
            close = row["close"]
            adx = row.get("adx", 0)
            rsi = row.get("rsi", 50)
            ema_200 = row.get("ema_200", close)
            ema_12 = row.get("ema_12", close)
            ema_12_prev = prev.get("ema_12", close)
            atr = row.get("atr", close * 0.02)
            timestamp = row["timestamp"]
            
            # LONG
            if position is None and close > ema_200:
                if adx >= 20 and 35 <= rsi <= 65:  # Relaxed from ADX>=25, RSI 42-55
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        type=SignalType.LONG,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={"adx": adx, "rsi": rsi},
                    ))
                    position = "LONG"
            
            # SHORT
            elif position is None and close < ema_200:
                if adx >= 20 and 35 <= rsi <= 65:  # Relaxed from ADX>=25, RSI 45-58
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        type=SignalType.SHORT,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={"adx": adx, "rsi": rsi},
                    ))
                    position = "SHORT"
            
            # Exit
            elif position == "LONG" and close < ema_200:
                signals.append(Signal(type=SignalType.CLOSE_LONG, timestamp=timestamp, price=close, metadata={"reason": "Trend reversal"}))
                position = None
            elif position == "SHORT" and close > ema_200:
                signals.append(Signal(type=SignalType.CLOSE_SHORT, timestamp=timestamp, price=close, metadata={"reason": "Trend reversal"}))
                position = None
        
        logger.info(f"AdxTrendFilterPlus generated {len(signals)} signals")
        return signals


__all__ = ["AdxTrendFilterPlus"]
