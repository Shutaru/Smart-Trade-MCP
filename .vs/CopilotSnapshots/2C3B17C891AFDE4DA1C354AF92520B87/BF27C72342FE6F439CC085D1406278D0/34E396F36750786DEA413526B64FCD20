import React, { useEffect, useState, useRef } from 'react'
import BotsList from '../components/BotsList'

const API = 'http://localhost:8000/api/v1/paper'

export default function PaperDashboard() {
  const [agents, setAgents] = useState<any[]>([])
  const [selected, setSelected] = useState<string | null>(null)
  const [details, setDetails] = useState<any | null>(null)
  const wsRef = useRef<WebSocket | null>(null)

  useEffect(() => {
    fetchAgents()
  }, [])

  async function fetchAgents() {
    const res = await fetch(`${API}/bots`)
    const data = await res.json()
    setAgents(data.agents || [])
  }

  async function selectAgent(id: string) {
    setSelected(id)
    const res = await fetch(`${API}/bots/${id}`)
    const data = await res.json()
    setDetails(data)

    // connect WS
    if (wsRef.current) {
      wsRef.current.close()
    }
    const ws = new WebSocket(`ws://localhost:8000/api/v1/paper/ws/paper/${id}`) // route already prefixed in router
    ws.onopen = () => console.log('ws open')
    ws.onmessage = (ev) => {
      const payload = JSON.parse(ev.data)
      // handle snapshot or event
      if (payload.type === 'snapshot') {
        setDetails({ agent: payload.agent, performance: payload.performance, trades: payload.trades })
      } else if (payload.type === 'event') {
        // append event
        setDetails((prev: any) => {
          const trades = prev?.trades || []
          const evt = payload.event
          if (evt['event_type'] === 'trade_open' || evt['event_type'] === 'trade_close') {
            // refetch trades for now
            fetch(`${API}/bots/${id}`).then(r => r.json()).then(d => setDetails(d))
          }
          return prev
        })
      }
    }
    wsRef.current = ws
  }

  return (
    <div className="min-h-screen p-8 bg-gray-50">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="col-span-1">
          <BotsList agents={agents} onSelect={selectAgent} />
        </div>

        <div className="col-span-2">
          {selected && details ? (
            <div className="bg-white rounded-2xl shadow-xl p-6">
              <h2 className="text-2xl font-bold mb-4">Bot Details - {selected}</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h3 className="font-semibold">Summary</h3>
                  <pre className="bg-gray-100 p-4 rounded mt-2">{JSON.stringify(details, null, 2)}</pre>
                </div>
                <div>
                  <h3 className="font-semibold">Trades</h3>
                  <div className="mt-2 max-h-64 overflow-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-gray-600">
                          <th>Time</th>
                          <th>Side</th>
                          <th>Entry</th>
                          <th>Exit</th>
                          <th>PnL</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(details.trades || []).map((t: any) => (
                          <tr key={t.id} className="border-b">
                            <td className="py-2">{t.entry_time}</td>
                            <td>{t.direction}</td>
                            <td>{t.entry_price}</td>
                            <td>{t.exit_price || '-'}</td>
                            <td className={`font-bold ${t.pnl > 0 ? 'text-green-600' : 'text-red-600'}`}>{t.pnl || '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <div className="bg-white rounded-2xl shadow-xl p-6">Select a bot to view details</div>
          )}
        </div>
      </div>
    </div>
  )
}
