"""
SuperTrend + ADX momentum with pullback entries
"""

from typing import List
import pandas as pd
import numpy as np

from ..base import BaseStrategy, Signal, SignalType, StrategyConfig
from ...core.logger import logger


class TrendflowSupertrend(BaseStrategy):
    """
    TrendflowSupertrend - SuperTrend + ADX momentum with pullback entries
    
    Category: trend_following
    Indicators: supertrend, adx, ema, rsi, atr
    
    Logic:
    - LONG: SuperTrend bullish + ADX >= 22 + (breakout OR pullback to EMA20)
    - SHORT: SuperTrend bearish + ADX >= 22 + (breakdown OR pullback to EMA20)
    """

    def __init__(self, config: StrategyConfig = None):
        """Initialize TrendflowSupertrend strategy."""
        super().__init__(config)
        
        # Strategy parameters
        self.adx_threshold = self.config.get("adx_threshold", 22)
        self.rsi_pullback_min = self.config.get("rsi_pullback_min", 40)
        self.rsi_pullback_max = self.config.get("rsi_pullback_max", 55)
        
    def get_required_indicators(self) -> List[str]:
        """Required indicators for this strategy."""
        return ["supertrend", "adx", "ema", "rsi", "atr"]
    
    def generate_signals(self, df: pd.DataFrame) -> List[Signal]:
        """
        Generate trading signals.
        
        Args:
            df: DataFrame with OHLCV and indicator data
            
        Returns:
            List of trading signals
        """
        signals = []
        
        # Verify required columns exist
        required = ["close", "high", "low", "adx", "rsi"]
        if not all(col in df.columns for col in required):
            logger.warning(f"Missing required columns for TrendflowSupertrend")
            return signals
        
        position = None  # Track position state
        
        for i in range(1, len(df)):
            row = df.iloc[i]
            prev_row = df.iloc[i - 1]
            
            close = row["close"]
            high = row["high"]
            low = row["low"]
            adx = row.get("adx", 0)
            rsi = row.get("rsi", 50)
            ema20 = row.get("ema_12", close)  # Fallback to close
            ema200 = row.get("ema_26", close)
            atr = row.get("atr", close * 0.02)
            
            # SuperTrend: simplified version (needs proper implementation)
            # For now, use EMA alignment as proxy
            supertrend_bull = ema20 > ema200
            supertrend_bear = ema20 < ema200
            
            # Get actual SuperTrend indicator
            st_trend = row.get("supertrend_trend", 0)
            st_trend_prev = prev_row.get("supertrend_trend", 0)
            
            # FIX: Simplified - just need SuperTrend flip + basic filters
            supertrend_flip_bull = st_trend > 0 and st_trend_prev <= 0
            supertrend_flip_bear = st_trend < 0 and st_trend_prev >= 0
            
            timestamp = row["timestamp"]
            
            # FIX: LONG - just SuperTrend flip + ADX > 15 (relaxed from 18)
            if position is None and adx >= 15:
                if supertrend_flip_bull and 30 < rsi < 70:
                    sl, tp = self.calculate_exit_levels(SignalType.LONG, close, atr)
                    signals.append(Signal(
                        type=SignalType.LONG,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={"adx": adx, "rsi": rsi, "reason": "SuperTrend flip bull"},
                    ))
                    position = "LONG"
            
            # FIX: SHORT - just SuperTrend flip + ADX > 15
            elif position is None and adx >= 15:
                if supertrend_flip_bear and 30 < rsi < 70:
                    sl, tp = self.calculate_exit_levels(SignalType.SHORT, close, atr)
                    signals.append(Signal(
                        type=SignalType.SHORT,
                        timestamp=timestamp,
                        price=close,
                        confidence=min(1.0, adx / 40),
                        stop_loss=sl,
                        take_profit=tp,
                        metadata={"adx": adx, "rsi": rsi, "reason": "SuperTrend flip bear"},
                    ))
                    position = "SHORT"
            
            # Exit on SuperTrend reverse
            elif position == "LONG" and st_trend < 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_LONG,
                    timestamp=timestamp,
                    price=close,
                    metadata={"reason": "SuperTrend reversed"},
                ))
                position = None
            
            elif position == "SHORT" and st_trend > 0:
                signals.append(Signal(
                    type=SignalType.CLOSE_SHORT,
                    timestamp=timestamp,
                    price=close,
                    metadata={"reason": "SuperTrend reversed"},
                ))
                position = None
        
        logger.info(f"TrendflowSupertrend generated {len(signals)} signals")
        return signals


__all__ = ["TrendflowSupertrend"]
